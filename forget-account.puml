@startuml TaskFlow
start

:Account recovery requested;

:Find user by email;

if ("Does the user exist?") then (Yes)
    if ("Is the account locked?") then (Yes)
        :Show error 429;
        stop
    endif

    if ("Is the code invalid or expired?") then (Yes)
        :Increase failed attempts;
        if ("Attempts >= 3") then (Yes)
            :Lock account for 5 minutes;
            :Reset attempts;
        endif
        :Show error 403 (Invalid or expired code);
        stop
    endif

    :Validate new password;

    if ("Is new password same as old one?") then (Yes)
        :Show error 409;
        stop
    endif

    :Reset code and lock status;
    :Update password;
    stop

else
    :Show error 404;
    stop
endif

@enduml
